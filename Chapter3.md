# Practical Malware Analysis, Lab 3

### Lab 3-1:

######Question 1 
The malware only has ExitProcess as an import. Definitely packed, Lab03-01.exe is just a wrapper. 

Strings:
!This program cannot be run in DOS mode.
ExitProcess
kernel32.dll
CONNECT %s:%i HTTP/1.0
advapi32
ntdll
user32
StubPath
SOFTWARE\Classes\htpp\shell\open\commandV
Software\Microsoft\Active Setup\Installed Components\
test
 www.practicalmalwareanalysis.com
admin
VideoDriver
vmx32to64.exe
SOFTWARE\Microsoft\Windows\CurrentVersion\Run
SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
AppData

######Question 2
Comparing the Regshot snapshots before and after execution, 3 keys and 48 values have been added. 9 values have been modified, but 2 of those are RNG seeds and can definitely be discounted since they change constantly anyway.

The first value added is:
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\VideoDriver: ...[string of hex here]...

This means Lab03-01.exe set the key 'VideoDriver' to run every time the user logs on.

Procmon shows a large number of processes. Three types of registry-related functions are being called - RegOpenKey, RegQueryValue, RegCloseKey - but the only registry values being set are RNG seeds and the VideoDriver value listed above. The only WriteFile process called writes vmx32to64.exe immediately before this registry value change.

Looking at this location, vmx32to64.exe has indeed been written to the system32 folder. So Lab03-01.exe has installed an executable is set to run at system startup.

######Question 3
Wireshark has picked up several packets which seem to be anywhere between 120 and 500 seconds apart. There are two repeating announcements being broadcast: Domain/Workgroup and Local Master. These are consistently 258 and 250 bytes in length respectively. Have since found out that these are normal and not signs of malicious activity.

No Netcat output on port 80.

Netcat output over port 443 is inconsistent garbage. No apparent signals or custom protocols here.



### Lab 3-2:

######Question 1
Looking through Lab03-02.dll's strings, this DLL uses the Install function. Running [rundll32.exe Lab03-02.dll, Install] or [rundll32.exe Lab03-02.dll, installA] might install it.

Windows functions are usually capitalised - installA is not. I ran this one first because it seemed the most suspect for that reason. Registry values have been altered by services.exe and rundll32.exe to point to Lab03-02.dll as a result, so it has installed itself.

######Question 2
The DLL has installed a service called IPRIP, which can be launched using [net start IPRIP].

######Question 3 
Lab03-02.dll is listed under svchost.exe's DLLs in Process Explorer, so it's running as part of this process (specifically svchost.exe with PID 1044).

######Question 4
Filtering to include only process name svchost.exe gives just over 50,000 events. 

######Question 5 
See above answers.

######Question 6
HTTP appears in strings, so netcat was set to listen on port 80. The following signature appeared after a long wait:

GET /serve.html HTTP:/1.1
Accept: */*
User-Agent: victim1-a020d27 Windows XP 6.11
Host: practicalmalwareanalysis.com

This consistently appears every time the malware is run. Everything except the machine name should be consistent across all infected machines (assuming the host URL doesn't change), so this can be used as a signature to identify Lab03-02.dll.



### Lab 3-3:

######Question 1 
On execution, Lab03-03.exe creates a new instance of svchost.exe (PID 2544 on Patient Zero). This isn't under services.exe, which is odd.

######Question 2
Checking the properties of this new svchost.exe process brings up discrepancies between the strings on the process image and in memory. practicalmalwareanalysis.log appears in the strings in memory, indicating that process replacement has taken place in live memory.

######Question 3 
Filtering procmon to only include events from PID 2544 initially brought up a blank screen. I went to investigate practicalmalwareanalysis.log through cmd and events attached to PID 2544 started appearing suddenly then stopped. These events appeared with every keypress in groups of four: CreateFile, QueryStandardInformationFile, WriteFile and CloseFile.

######Question 4 
This appears to be a keylogger. The practicalmalwareanalysis.log file contains information on each keypress and the title of the window it occurs in. 



### Lab 3-4:

######Question 1 
Strings for Lab03-04.exe brings up several interesting things: www.practicalmalwareanalysis.com, indicating there will probably be communication between the malware and a remote server. Timezone-related functions, weekdays and months also appear, this could indicate the program creates a log of user activity?

######Question 2 
When run from cmd, Lab03-04.exe deletes itself. Procmon shows a ProcessCreate event - investigating this shows that the process is using command line to set itself to 'NUL', which is why it's being deleted from the folder.

######Question 3 
Running Lab03-04.exe from command line with the flags given in strings (-in, -re, -cc) just gives the same results. Hit a brick wall for now.

